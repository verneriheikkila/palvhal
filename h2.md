# h2 Karjaa

## Cattle, not pets.

Tehtävät tehty Windows hostilla huvin ja urheilun vuoksi.

### x.)

**Slater 2017: [Mikä on "karjan, joka ei ole lemmikkieläin" määritelmä?](https://devops.stackexchange.com/questions/653/what-is-the-definition-of-cattle-not-pets#654)**

-   "Lemmikit" ovat palvelimia, joita pidetään korvaamattomina ja konfiguroidaan manuaalisesti.
-   "Karja" on automaatiotyökaluilla rakennettu palvelinkokoelma, joka kestää palvelinten vikaantumiset ilman ihmisen väliintuloa.

**Karvinen 2017: [Vagrant Revisited - Asenna ja käynnistä uusi virtuaalikone 31 sekunnissa](https://terokarvinen.com/2017/04/11/vagrant-revisited-install-boot-new-virtual-machine-in-31-seconds/)**

-   Opas Vagrantin ja VirtualBoxin asentamiseen Linuxiin, uuden virtuaalikoneen käynnistämiseen ja yhdistymiseen SSH:n kautta sekä virtuaalikoneen tuhoamiseen.

**Karvinen 2023: [Salt Vagrant - Ota automaattisesti käyttöön yksi master ja kaksi slavea](https://terokarvinen.com/2023/salt-vagrant/)**

-   Artikkeli selittää, miten voit käyttää valmista verkkoa, joka sisältää kolme virtuaalikonetta (master ja kaksi slavea) Saltin kanssa.
-   Siinä annetaan vaiheittaiset ohjeet, kuten virtuaaliympäristön asennus, virtuaalikoneiden käynnistys, orjakoneiden avainten hyväksyminen ja virtuaalikoneiden tuhoaminen.

### a) Asenna Vagrant. (Toiminee parhaiten isäntäkäyttöjärjestelmässä, siis siinä, joka pyörii raudalla)

Seurasin ohjeita sivulla:
[Official Vagrant Installation Document](https://developer.hashicorp.com/vagr)

Latasin levykuvan windows käyttäjälle virallisesta Vagrant asennus Windows amd64 arkkitehtuurille [linkistä](https://releases.hashicorp.com/vagrant/2.4.0/vagrant_2.4.0_windows_amd64.msi) ohjeiden mukaisesti.

Dokumentti ilmoitti että jos Vagranttia ajaa HyperV päällä tulee kohtaamaan BSOD:n. Kuulostaa pelottavalta. Laitetaan se pois jo aikaisessa vaiheessa, ettei unohdu.
Varmistin että HyperV on pois päällä hakemalla Windows haulla "Turn Windows features on or off" ja tarkistamalla, että kohdassa:

\*[ ]Windows Hypervisor Platform

Ei ollut raksia ruudussa. Jatkoin suorittamaan ladatun asennustiedoston. Installer oli verrattaen yksinkertainen – tarvitsi sen ajettuaan klikata "Install" sekä "Finish". Tämän jälkeen asennusohjelma ilmoitti vielä, että tietokone tulee käynnistää uudestaan jotta järjestelmäkonfiguraatioon tehdyt muutokset tulevat voimaan.
Kysyi vielä kauniisti, että saako hän suorittaa tämän kunnian. Vastasin kyllä ja odotin, että järjestelmä käynnistyy uudestaan.

Asennuksen tulisi olla valmis koneen käynnistyttyä uudestaan. Katsotaan miten käy.

Varmistin asennuksen ajamalla "vagrant" komennon GitBashissa:

```
[07:15:47] [/] ❱❱❱ vagrant

Usage: vagrant [options] <command> [<args>]

  -h, --help                                  Print this help.

Common commands:
    autocomplete                               manages autocomplete installation on host
    jne...

```

Tulostui käyttöohje eli lista lisämääreitä millä ohjelmaa tulee komentotulkilla ajaa.

### b) Yksi maankiertäjä. Asenna yksi kone Vagrantilla, ota siihen SSH-yhteys, osoita että netti toimii.

Seurasin asennusdokumentistä löytynyttä [ohjetta](https://developer.hashicorp.com/vagrant/tutorials/getting-started/getting-started-project-setup) yhden maankiertäjän (Boxin) asennukseta.

Käytin myös hyödykseni lukemaani Tero Karvisen "[Vagrant Revisited – Install & Boot New Virtual Machine in 31 seconds](https://terokarvinen.com/2017/04/11/vagrant-revisited-install-boot-new-virtual-machine-in-31-seconds/)" artikkelia.

Olin jo valmiiksi projektin juurikansiossa joten loin kansion jonne vagtant alustetaan ja sille isäntäkansion, että se voidaan yhdistää tehtävään.

```
[07:37:28] [~/HH/palvhal] [main ✖] ❱❱❱ mkdir -p h2/vagrant_getting_started
```

Siirryin opastetusti neuvottuun kansioon.

```
[07:37:55] [~/HH/palvhal] [main ✖] ❱❱❱ cd h2/vagrant_getting_started
```

Alustin projektini Hasihcorpin tarjoamalla kuvalla Ubuntun BionicBeaverista. Tuloste ilmoittaa myös että init komento on luonut Vagrantfilen kansioon joka toimii virtuaaliympäristön configuraatiotiedostona. Init ilmoittaa myös että voimme käynnistää virtuaaliympäristön vagrant up komennolla. Komento siis loi meille jonkinlaisen alustavan ympäristön.

```
[07:38:07] [~/HH/palvhal/h2/vagrant_getting_started] [main ✖] ❱❱❱ vagrant init hashicorp/bionic64

A `Vagrantfile` has been placed in this directory. You are now
ready to `vagrant up` your first virtual environment! Please read
the comments in the Vagrantfile as well as documentation on
`vagrantup.com` for more information on using Vagrant.
```

Katsotaan mitä se pitää sisällään.

```
[07:57:16] [~/HH/palvhal/h1/vagrant_getting_started] [main ✖] ❱❱❱ cat Vagrantfile
# -*- mode: ruby -*-
# vi: set ft=ruby :

# All Vagrant configuration is done below. The "2" in Vagrant.configure
# configures the configuration version (we support older styles for
# backwards compatibility). Please don't change it unless you know what
# you're doing.
Vagrant.configure("2") do |config|
  # The most common configuration options are documented and commented below.
  # For a complete reference, please see the online documentation at
  # https://docs.vagrantup.com.

  # Every Vagrant development environment requires a box. You can search for
  # boxes at https://vagrantcloud.com/search.

  config.vm.box = "hashicorp/bionic64"

  # Disable automatic box update checking. If you disable this, then
  # boxes will only be checked for updates when the user runs
  # `vagrant box outdated`. This is not recommended.
  # config.vm.box_check_update = false

  # Create a forwarded port mapping which allows access to a specific port
  # within the machine from a port on the host machine. In the example below,
  # accessing "localhost:8080" will access port 80 on the guest machine.
  # NOTE: This will enable public access to the opened port
  # config.vm.network "forwarded_port", guest: 80, host: 8080

  # Create a forwarded port mapping which allows access to a specific port
  # within the machine from a port on the host machine and only allow access
  # via 127.0.0.1 to disable public access
  # config.vm.network "forwarded_port", guest: 80, host: 8080, host_ip: "127.0.0.1"

  # Create a private network, which allows host-only access to the machine
  # using a specific IP.
  # config.vm.network "private_network", ip: "192.168.33.10"

  # Create a public network, which generally matched to bridged network.
  # Bridged networks make the machine appear as another physical device on
  # your network.
  # config.vm.network "public_network"

  # Share an additional folder to the guest VM. The first argument is
  # the path on the host to the actual folder. The second argument is
  # the path on the guest to mount the folder. And the optional third
  # argument is a set of non-required options.
  # config.vm.synced_folder "../data", "/vagrant_data"

  # Disable the default share of the current code directory. Doing this
  # provides improved isolation between the vagrant box and your host
  # by making sure your Vagrantfile isn't accessable to the vagrant box.
  # If you use this you may want to enable additional shared subfolders as
  # shown above.
  # config.vm.synced_folder ".", "/vagrant", disabled: true

  # Provider-specific configuration so you can fine-tune various
  # backing providers for Vagrant. These expose provider-specific options.
  # Example for VirtualBox:
  #
  # config.vm.provider "virtualbox" do |vb|
  #   # Display the VirtualBox GUI when booting the machine
  #   vb.gui = true
  #
  #   # Customize the amount of memory on the VM:
  #   vb.memory = "1024"
  # end
  #
  # View the documentation for the provider you are using for more
  # information on available options.

  # Enable provisioning with a shell script. Additional provisioners such as
  # Ansible, Chef, Docker, Puppet and Salt are also available. Please see the
  # documentation for more information about their specific syntax and use.
  # config.vm.provision "shell", inline: <<-SHELL
  #   apt-get update
  #   apt-get install -y apache2
  # SHELL
end
```

Vagrantfilen alussa on määritelty konfiguraatio versio ja sen jölkeen itse konfiguraatio osuudessa määritelty, että Vagrant pystyttää yhden boxin kun se ajetaan ylös komennolla "vagrant up". Tiedostosa on myös kommentoituna esitelty useita muita konfiguraatiovaihtoehtoja ja kerrottu melko tarkasti mitä ne tekevät.

```
[08:42:05] [~/HH/palvhal/h1/vagrant_getting_started] [main ✖] ❱❱❱ vagrant up
Bringing machine 'default' up with 'virtualbox' provider...
==> default: Box 'hashicorp/bionic64' could not be found. Attempting to find and install...
    default: Box Provider: virtualbox
    default: Box Version: >= 0
==> default: Loading metadata for box 'hashicorp/bionic64'
    default: URL: https://vagrantcloud.com/api/v2/vagrant/hashicorp/bionic64
==> default: Adding box 'hashicorp/bionic64' (v1.0.282) for provider: virtualbox
    default: Downloading: https://vagrantcloud.com/hashicorp/boxes/bionic64/versions/1.0.282/providers/virtualbox/unknown/vagrant.box
    default:
==> default: Successfully added box 'hashicorp/bionic64' (v1.0.282) for 'virtualbox'!
==> default: Importing base box 'hashicorp/bionic64'...
==> default: Matching MAC address for NAT networking...
==> default: Checking if box 'hashicorp/bionic64' version '1.0.282' is up to date...
==> default: Setting the name of the VM: vagrant_getting_started_default_1699425793467_27152
Vagrant is currently configured to create VirtualBox synced folders with
the `SharedFoldersEnableSymlinksCreate` option enabled. If the Vagrant
guest is not trusted, you may want to disable this option. For more
information on this option, please refer to the VirtualBox manual:

  https://www.virtualbox.org/manual/ch04.html#sharedfolders

This option can be disabled globally with an environment variable:

  VAGRANT_DISABLE_VBOXSYMLINKCREATE=1

or on a per folder basis within the Vagrantfile:

  config.vm.synced_folder '/host/path', '/guest/path', SharedFoldersEnableSymlinksCreate: false
==> default: Clearing any previously set network interfaces...
==> default: Preparing network interfaces based on configuration...
    default: Adapter 1: nat
==> default: Forwarding ports...
    default: 22 (guest) => 2222 (host) (adapter 1)
==> default: Booting VM...
==> default: Waiting for machine to boot. This may take a few minutes...
    default: SSH address: 127.0.0.1:2222
    default: SSH username: vagrant
    default: SSH auth method: private key
    default:
    default: Vagrant insecure key detected. Vagrant will automatically replace
    default: this with a newly generated keypair for better security.
    default:
    default: Inserting generated public key within guest...
    default: Removing insecure key from the guest if it's present...
    default: Key inserted! Disconnecting and reconnecting using new SSH key...
==> default: Machine booted and ready!
==> default: Checking for guest additions in VM...
    default: The guest additions on this VM do not match the installed version of
    default: VirtualBox! In most cases this is fine, but in rare cases it can
    default: prevent things such as shared folders from working properly. If you see
    default: shared folder errors, please make sure the guest additions within the
    default: virtual machine match the version of VirtualBox you have installed on
    default: your host and reload your VM.
    default:
    default: Guest Additions Version: 6.0.10
    default: VirtualBox Version: 7.0
==> default: Mounting shared folders...
    default: /vagrant => C:/Users/verne/HH/palvhal/h1/vagrant_getting_started
```

![Alt text](image.png)

Kokeillaan vielä ottaa koneeseen SSH yhteys ja katsoa onko kone verkossa tekemällä ping google.com:iin.
SSH-yhteys onnistuu ja ping vastaa.

```
[17:56:46] [~/HH/palvhal/h2/vagrant_getting_started] [main ✖] ❱❱❱ vagrant ssh
vagrant@127.0.0.1's password:
vagrant@127.0.0.1's password:
Welcome to Ubuntu 18.04.3 LTS (GNU/Linux 4.15.0-58-generic x86_64)

 * Documentation:  https://help.ubuntu.com
 * Management:     https://landscape.canonical.com
 * Support:        https://ubuntu.com/advantage

  System information as of Wed Nov  8 15:58:15 UTC 2023

  System load:  0.0               Processes:           88
  Usage of /:   2.5% of 61.80GB   Users logged in:     0
  Memory usage: 11%               IP address for eth0: 10.0.2.15
  Swap usage:   0%

 * Strictly confined Kubernetes makes edge and IoT secure. Learn how MicroK8s
   just raised the bar for easy, resilient and secure K8s cluster deployment.

   https://ubuntu.com/engage/secure-kubernetes-at-the-edge

0 packages can be updated.
0 updates are security updates.


vagrant@vagrant:~$ ping google.com
PING google.com (216.58.211.238) 56(84) bytes of data.
64 bytes from mad01s24-in-f14.1e100.net (216.58.211.238): icmp_seq=1 ttl=58 time=4.28 ms
```

### c) Oma orjansa. Asenna Salt herra ja orja samalle koneelle.

Päivitin tehtävänantosivun vinkkien mukaisesti pakettivarastot.

```
vagrant@vagrant:~$ sudo apt update
Hit:1 http://archive.ubuntu.com/ubuntu bionic InRelease
Get:2 http://archive.ubuntu.com/ubuntu bionic-updates InRelease [88.7 kB]
Get:3 http://security.ubuntu.com/ubuntu bionic-security InRelease [88.7 kB]
Get:4 http://archive.ubuntu.com/ubuntu bionic-backports InRelease [83.3 kB]
Get:5 http://archive.ubuntu.com/ubuntu bionic-updates/main amd64 Packages [3,045 kB]
Get:6 http://archive.ubuntu.com/ubuntu bionic-updates/main i386 Packages [1,665 kB]
Get:7 http://security.ubuntu.com/ubuntu bionic-security/main amd64 Packages [2,717 kB]
Get:8 http://archive.ubuntu.com/ubuntu bionic-updates/main Translation-en [553 kB]
Get:9 http://archive.ubuntu.com/ubuntu bionic-updates/restricted amd64 Packages [1,347 kB]
Get:10 http://archive.ubuntu.com/ubuntu bionic-updates/restricted i386 Packages [39.7 kB]
jne...
```

Päivitin tehtävänantosivun ohjeen mukaisesti paketit (-y hyväksyy kysymykset automaattisesti.)

```
vagrant@vagrant:~$ sudo apt upgrade -y
Reading package lists... Done
Building dependency tree
Reading state information... Done
Calculating upgrade... Done
The following NEW packages will be installed:
  dbus-user-session distro-info efibootmgr libefiboot1 libefivar1 libnetplan0 linux-image-4.15.0-213-generic linux-modules-4.15.0-213-generic linux-modules-extra-4.15.0-213-generic
  motd-news-config python3-pexpect python3-ptyprocess
The following packages will be upgraded:
  accountsservice amd64-microcode apparmor apport apt apt-utils base-files bash bcache-tools bind9-host binutils binutils-common binutils-x86-64-linux-gnu bsdutils
  busybox-initramfs busybox-static ca-certificates cifs-utils cpio cpp-7 cron cryptsetup cryptsetup-bin curl dbus dirmngr distro-info-data dmeventd dmidecode dmsetup dnsmasq-base
  dnsutils dpkg e2fsprogs fdisk file gcc-7-base gcc-8-base git git-man gnupg gnupg-l10n gnupg-utils gpg gpg-agent gpg-wks-client gpg-wks-server gpgconf gpgsm gpgv grep grub-common
  jne...
```

Saman neuvon mukaisesti asennetaan salt-master

```
vagrant@vagrant:~$ sudo apt install salt-master
Reading package lists... Done
Building dependency tree
Reading state information... Done
The following packages were automatically installed and are no longer required:
  linux-image-unsigned-4.15.0-55-generic linux-modules-4.15.0-55-generic
Use 'sudo apt autoremove' to remove them.
The following additional packages will be installed:
  libgit2-26 libhttp-parser2.7.1 libnorm1 libpgm-5.2-0 libsodium23 libssh2-1 libzmq5 python3-croniter python3-crypto python3-dateutil python3-jinja2 python3-markupsafe
  python3-msgpack python3-psutil python3-pygit2 python3-tornado python3-tz python3-zmq salt-common
Suggested packages:
  python-crypto-doc python-jinja2-doc python-psutil-doc python-pygit2-doc python3-pycurl python-tornado-doc python3-mako salt-doc
The following NEW packages will be installed:
  libgit2-26 libhttp-parser2.7.1 libnorm1 libpgm-5.2-0 libsodium23 libssh2-1 libzmq5 python3-croniter python3-crypto python3-dateutil python3-jinja2 python3-markupsafe
  python3-msgpack python3-psutil python3-pygit2 python3-tornado python3-tz python3-zmq salt-common salt-master
0 upgraded, 20 newly installed, 0 to remove and 0 not upgraded.
Need to get 5,380 kB of archives.
After this operation, 31.4 MB of additional disk space will be used.
Do you want to continue? [Y/n]
Get:1 http://archive.ubuntu.com/ubuntu bionic/universe amd64 libnorm1 amd64 1.5r6+dfsg1-6 [224 kB]
Get:2 http://archive.ubuntu.com/ubuntu bionic/universe amd64 libpgm-5.2-0 amd64 5.2.122~dfsg-2 [157 kB]
jne...
```

ja edeleen salt-minion komennolla

```
vagrant@vagrant:~$ sudo apt install salt-minion
Reading package lists... Done
Building dependency tree
Reading state information... Done
The following packages were automatically installed and are no longer required:
  linux-image-unsigned-4.15.0-55-generic linux-modules-4.15.0-55-generic
Use 'sudo apt autoremove' to remove them.
The following additional packages will be installed:
  dctrl-tools debconf-utils
Suggested packages:
  debtags python3-augeas
Recommended packages:
Selecting previously unselected package salt-minion.
Preparing to unpack .../salt-minion_2017.7.4+dfsg1-1ubuntu18.04.2_all.deb ...
jne...
```

Tajusin väsyneenä lähteneeni asentamaan niitä Vagrant koneelleni.
Se ei kaiketi ollut tarkoitus?
Noh... Tulipahan tehtyä.
Tuhotaan koneet kirjautumalla komennolla "exit" ulos ja tuhoamalla sen jälkeen kone "vagrant destroy"

```
vagrant@vagrant:~$ exit
logout
[19:58:07] [~/HH/palvhal/h2/vagrant_getting_started] [main ✖] ❱❱❱ vagrant destroy
    default: Are you sure you want to destroy the 'default' VM? [y/N] y
==> default: Forcing shutdown of VM...
==> default: Destroying VM and associated drives...
```

### d) Asenna Saltin herra-orja arkkitehtuuri toimimaan verkon yli.

Tässä tehtävässä sovelsin kohdassa x.) tiivistämääni esimerkkiä julkaisussa [Karvinen 2023: Salt Vagrant - Ota automaattisesti käyttöön yksi master ja kaksi slavea](https://terokarvinen.com/2023/salt-vagrant/) ja ensimmäisissä kohdissani käyttämää esimerkkiä siitä miten [projektikansio alustetaan](https://developer.hashicorp.com/vagrant/tutorials/getting-started/getting-started-project-setup)

-   Projektikansion mkdir komennolla
-   Siirryin siihen "cd" komennolla.
-   Alustin projektikansion "vagrant init" komennolla.

```
[20:07:23] [~/HH/palvhal/h2/ [main ✖] ❱❱❱ mkdir salt_mastmini_example
[20:08:30] [~/HH/palvhal/h2/ [main ✖] ❱❱❱ cd salt_mastmini_example
[20:08:40] [~/HH/palvhal/h2/salt_mastmini_example] [main ✖] ❱❱❱ vagrant init
A `Vagrantfile` has been placed in this directory. You are now
ready to `vagrant up` your first virtual environment! Please read
the comments in the Vagrantfile as well as documentation on
`vagrantup.com` for more information on using Vagrant.
```

Kopioin Vagrantfile:n Teron esimerkistä vscodessa Vagrantfile:eni. Ylemmässä osassa ilmeisesti siis määritellään Mestari ja Mini-Joni. Toisessa osassa konfiguroidaaan Virtuaalikoneet. Varmistin vielä, että rakenne on täysin sama kun windows hostilla.

```
# -*- mode: ruby -*-
# vi: set ft=ruby :
# Copyright 2014-2023 Tero Karvinen http://TeroKarvinen.com

$minion = <<MINION
sudo apt-get update
sudo apt-get -qy install salt-minion
echo "master: 192.168.12.3">/etc/salt/minion
sudo service salt-minion restart
echo "See also: https://terokarvinen.com/2023/salt-vagrant/"
MINION

$master = <<MASTER
sudo apt-get update
sudo apt-get -qy install salt-master
echo "See also: https://terokarvinen.com/2023/salt-vagrant/"
MASTER

Vagrant.configure("2") do |config|
	config.vm.box = "debian/bullseye64"

	config.vm.define "t001" do |t001|
		t001.vm.provision :shell, inline: $minion
		t001.vm.network "private_network", ip: "192.168.12.100"
		t001.vm.hostname = "t001"
	end

	config.vm.define "t002" do |t002|
		t002.vm.provision :shell, inline: $minion
		t002.vm.network "private_network", ip: "192.168.12.102"
		t002.vm.hostname = "t002"
	end

	config.vm.define "tmaster", primary: true do |tmaster|
		tmaster.vm.provision :shell, inline: $master
		tmaster.vm.network "private_network", ip: "192.168.12.3"
		tmaster.vm.hostname = "tmaster"
	end
end
```

Alla näkyvästä tulosteesta voimme tulkita, että salt-koneet tuodaan tarjolle virtualbox providerille, jonka jälkeen koneetita lähdetään asentamaan vagrant boxille vagrantfile:n määrittelemien määreiden mukaisesti. Tulosteen alkuosassa näkyy kun salt-minion koneet lähtevät asennettavaksi ja niille luodaan ssh-avain parit (kuten myös tmasterille myöhemmin). Asennus myös ilmoittaa, ettei salt-koneiden "guest additions" versio ole sama kun vagrant boxilla ja tästä johtuvista mahdollisista harvinaisita järjestelmän pienistä mahdollisista epävakauksista. Lopputulosteesta näemme, että asennus on jatkunut salt-master koneelle, jonka asennuksen se suorittaa onnistuneesti loppuun ja lopuksi molempien koneiden tilasta ilmoitetaan viestillä, että ne ovat ylhäällä.

```
[21:34:41] [~/HH/palvhal/h2/master_minion] [main ✖] ❱❱❱ Vagrant up
Bringing machine 't001' up with 'virtualbox' provider...
Bringing machine 't002' up with 'virtualbox' provider...
Bringing machine 'tmaster' up with 'virtualbox' provider...
==> t001: Importing base box 'debian/bullseye64'...
==> t001: Matching MAC address for NAT networking...
==> t001: Checking if box 'debian/bullseye64' version '11.20231009.1' is up to date...
==> t001: Setting the name of the VM: master_minion_t001_1699488615712_92687
==> t001: Clearing any previously set network interfaces...
==> t001: Preparing network interfaces based on configuration...
    t001: Adapter 1: nat
    t001: Adapter 2: hostonly
==> t001: Forwarding ports...
    t001: 22 (guest) => 2222 (host) (adapter 1)
==> t001: Booting VM...
==> t001: Waiting for machine to boot. This may take a few minutes...
    t001: SSH address: 127.0.0.1:2222
    t001: SSH username: vagrant
    t001: SSH auth method: private key
    t001:
    t001: Vagrant insecure key detected. Vagrant will automatically replace
    t001: this with a newly generated keypair for better security.
    t001:
    t001: Inserting generated public key within guest...
    t001: Removing insecure key from the guest if it's present...
    t001: Key inserted! Disconnecting and reconnecting using new SSH key...
==> t001: Machine booted and ready!
==> t001: Checking for guest additions in VM...
    t001: The guest additions on this VM do not match the installed version of
    t001: VirtualBox! In most cases this is fine, but in rare cases it can
    t001: prevent things such as shared folders from working properly. If you see
    t001: shared folder errors, please make sure the guest additions within the
    t001: virtual machine match the version of VirtualBox you have installed on
    t001: your host and reload your VM.
   ....
    tmaster: Setting up libmbedx509-0:amd64 (2.16.9-0.1) ...
    tmaster: Setting up libmbedtls12:amd64 (2.16.9-0.1) ...
    tmaster: Setting up python3-croniter (0.3.34-3) ...
    tmaster: Setting up python3-zmq (20.0.0-1+b1) ...
    tmaster: Setting up libgit2-1.1:amd64 (1.1.0+dfsg.1-4+deb11u1) ...
    tmaster: Setting up python3-pygit2 (1.4.0+dfsg1-1) ...
    tmaster: Setting up salt-common (3002.6+dfsg1-4+deb11u1) ...
    tmaster: Setting up salt-master (3002.6+dfsg1-4+deb11u1) ...
    tmaster: Created symlink /etc/systemd/system/multi-user.target.wants/salt-master.service → /lib/systemd/system/salt-master.service.
    tmaster: Processing triggers for man-db (2.9.4-2) ...
    tmaster: Processing triggers for libc-bin (2.31-13+deb11u6) ...
    tmaster: See also: https://terokarvinen.com/2023/salt-vagrant/

==> t001: Machine 't001' has a post `vagrant up` message. This is a message
==> t001: from the creator of the Vagrantfile, and not from Vagrant itself:
==> t001:
==> t001: Vanilla Debian box. See https://app.vagrantup.com/debian for help and bug reports

==> t002: Machine 't002' has a post `vagrant up` message. This is a message
==> t002: from the creator of the Vagrantfile, and not from Vagrant itself:
==> t002:
==> t002: Vanilla Debian box. See https://app.vagrantup.com/debian for help and bug reports

==> tmaster: Machine 'tmaster' has a post `vagrant up` message. This is a message
==> tmaster: from the creator of the Vagrantfile, and not from Vagrant itself:
==> tmaster:
==> tmaster: Vanilla Debian box. See https://app.vagrantup.com/debian for help and bug reports
```

Eli nyt on tehty mitä oli ilmeisesti tarkoitus tehdä edellisessä kohdassa (yhden ylimääräisen minionin kera, jonka unohdin poistaa, enkä kokenut sitä tarpeelliseksi harjoituksen mielekkyyden kannalta).
Siirytään siis nyt tämän kohdan varsinaisiin tavoitteisiin.
Jatketaan Karvisen ohjeen seuraamista kohtaan jossa kirjaudutaan tmasterille, että saammme hyväksyttyä minionin.
Kirjaudutaan tmaster-koneelle SSH-yhteydellä.

tämä tuottaavirheen:

```
vagrant@127.0.0.1: Permission denied (publickey).
```

Alan epäilemään voiko tämä johtua siitä, että ajan gitbashia, joka hakee ssh avaimia polusta "~/.ssh/", koska olen generoinut sillä sinne avaimia.
Tarkastan vielä komennolla "vagrant ssh-config", että konfiguraatiot ovat jossain olemassa. Tuloste antaisi ymmärtää niin. Polkukin on ilmoitettu. Se on .vagrant konfiguraation alla.

```
[02:34:36] [~/HH/palvhal/h2/master_minion] [main ✖] ❱❱❱ vagrant ssh-config
Host t001
  HostName 127.0.0.1
  User vagrant
  Port 2222
  UserKnownHostsFile /dev/null
  StrictHostKeyChecking no
  PasswordAuthentication no
  IdentityFile C:/Users/verne/HH/palvhal/h2/master_minion/.vagrant/machines/t001/virtualbox/private_key
  IdentitiesOnly yes
  LogLevel FATAL
  PubkeyAcceptedKeyTypes +ssh-rsa
  HostKeyAlgorithms +ssh-rsa

Host t002
  HostName 127.0.0.1
  User vagrant
  Port 2200
  UserKnownHostsFile /dev/null
  StrictHostKeyChecking no
  PasswordAuthentication no
  IdentityFile C:/Users/verne/HH/palvhal/h2/master_minion/.vagrant/machines/t002/virtualbox/private_key
  IdentitiesOnly yes
  LogLevel FATAL
  PubkeyAcceptedKeyTypes +ssh-rsa
  HostKeyAlgorithms +ssh-rsa

Host tmaster
  HostName 127.0.0.1
  User vagrant
  Port 2201
  UserKnownHostsFile /dev/null
  StrictHostKeyChecking no
  PasswordAuthentication no
  IdentityFile C:/Users/verne/HH/palvhal/h2/master_minion/.vagrant/machines/tmaster/virtualbox/private_key
  IdentitiesOnly yes
  LogLevel FATAL
  PubkeyAcceptedKeyTypes +ssh-rsa
  HostKeyAlgorithms +ssh-rsa
```

Päätän testata ajaa Vagranttia windowsin komentotulkilla (winkey+"cmd"+enter) ja siirryn kansioon jossa haluan ajaa Vagranttia. Ajan saman "vagrant ssh tmaster"-komennon kuin gitbashissa. Pääsen kirjautumaan sisään. Eli hypoteesini saattoi olla oikea? Jännittävää, koska olin muistavinani lukenevani Vagrantin dokumentaatiosta, että sitä kehotettiin nimenomaan ajamaan gitbash:illä. Toinen syy voi olla, että oon rikkonut mun GitBashin, kun sitä on pitänyt puukottaa, että siitä saa hienon, värikkään ja vilkkuvan. Noh... ehkä tästä opittiin jotain.

```
C:\Users\verne\HH\palvhal\h2\master_minion>vagrant ssh tmaster
Linux tmaster 5.10.0-26-amd64 #1 SMP Debian 5.10.197-1 (2023-09-29) x86_64
The programs included with the Debian GNU/Linux system are free software;
the exact distribution terms for each program are described in the individual files in /usr/share/doc/*/copyright.
Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent permitted by applicable law.
vagrant@tmaster:~$
```

Jatketaan hyväksymään minionit.

```
Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent permitted by applicable law.vagrant@tmaster:~$ sudo salt-key -A
The following keys are going to be accepted:
Unaccepted Keys:
t001
t002
Proceed? [n/Y]
Key for minion t001 accepted.
Key for minion t002 accepted.
```

Testataan yhteys.

```
vagrant@tmaster:~$ sudo salt '*' test.ping
t001:
    True
t002:
    True

```

Arkkitehtuuri toimii verkon yli

### e) Aja useita idempotentteja (state.single) komentoja verkon yli.

Aloitetaan vanhasta harjoituksesta tutulla pkg.installed ja vaikka tuttu apache2 tälläkertaa. Kaikille minioneille. Tuloste kertoo että paketti (ja riippuvuudet) asennetaan. Summaryssä tuloste kertoo että 1 onnistunu (1 muuttunut) ja 0 epäonnistunut. Ajetaan sama komento uudestaan ja tuloste ilmoittaa, että 1 onnistunut (ei mitään muuttumisesta) ja 0 epäonnistunut ja että kaikki määritellyt paketit ovat jo asennettuja. Komento siis tarkistaa onko haluttu tila saavutettu, ja jos on, niin sen tila ei muutu. Se on siis idempotentti.

```
vagrant@tmaster:~$ sudo salt '*' state.single pkg.installed apache2
t002:
----------
          ID: apache2
    Function: pkg.installed
      Result: True
     Comment: The following packages were installed/updated: apache2
     Started: 01:23:09.137668
    Duration: 7813.643 ms
     Changes:
              ----------
              apache2:
                  ----------
                  new:
                      2.4.56-1~deb11u2
                  old:
              apache2-bin:
                  ----------
                  new:
                      2.4.56-1~deb11u2
                  old:
              apache2-data:
                  ----------
                  new:
                      2.4.56-1~deb11u2
                  old:
              apache2-utils:
                  ----------
                  new:
                      2.4.56-1~deb11u2
                  old:
              libapr1:
                  ----------
                  new:
                      1.7.0-6+deb11u2
                  old:
              libaprutil1:
                  ----------
                  new:
                      1.6.1-5+deb11u1
                  old:
              libaprutil1-dbd-sqlite3:
                  ----------
                  new:
                      1.6.1-5+deb11u1
                  old:
              libaprutil1-ldap:
                  ----------
                  new:
                      1.6.1-5+deb11u1
                  old:
              libcurl4:
                  ----------
                  new:
                      7.74.0-1.3+deb11u10
                  old:
              liblua5.3-0:
                  ----------
                  new:
                      5.3.3-1.1+deb11u1
                  old:
              ssl-cert:
                  ----------
                  new:
                      1.1.0+nmu1
                  old:

Summary for t002
------------
Succeeded: 1 (changed=1)
Failed:    0
------------
Total states run:     1
Total run time:   7.814 s
t001:
----------
          ID: apache2
    Function: pkg.installed
      Result: True
     Comment: The following packages were installed/updated: apache2
     Started: 01:23:09.147820
    Duration: 7975.384 ms
     Changes:
              ----------
              apache2:
                  ----------
                  new:
                      2.4.56-1~deb11u2
                  old:
              apache2-bin:
                  ----------
                  new:
                      2.4.56-1~deb11u2
                  old:
              apache2-data:
                  ----------
                  new:
                      2.4.56-1~deb11u2
                  old:
              apache2-utils:
                  ----------
                  new:
                      2.4.56-1~deb11u2
                  old:
              libapr1:
                  ----------
                  new:
                      1.7.0-6+deb11u2
                  old:
              libaprutil1:
                  ----------
                  new:
                      1.6.1-5+deb11u1
                  old:
              libaprutil1-dbd-sqlite3:
                  ----------
                  new:
                      1.6.1-5+deb11u1
                  old:
              libaprutil1-ldap:
                  ----------
                  new:
                      1.6.1-5+deb11u1
                  old:
              libcurl4:
                  ----------
                  new:
                      7.74.0-1.3+deb11u10
                  old:
              liblua5.3-0:
                  ----------
                  new:
                      5.3.3-1.1+deb11u1
                  old:
              ssl-cert:
                  ----------
                  new:
                      1.1.0+nmu1
                  old:

Summary for t001
------------
Succeeded: 1 (changed=1)
Failed:    0
------------
Total states run:     1
Total run time:   7.975 s
vagrant@tmaster:~$ sudo salt '*' state.single pkg.installed apache2
t002:
----------
          ID: apache2
    Function: pkg.installed
      Result: True
     Comment: All specified packages are already installed
     Started: 01:23:25.408237
    Duration: 27.698 ms
     Changes:

Summary for t002
------------
Succeeded: 1
Failed:    0
------------
Total states run:     1
Total run time:  27.698 ms
t001:
----------
          ID: apache2
    Function: pkg.installed
      Result: True
     Comment: All specified packages are already installed
     Started: 01:23:25.431983
    Duration: 20.999 ms
     Changes:

Summary for t001
------------
Succeeded: 1
Failed:    0
------------
Total states run:     1
Total run time:  20.999 ms
```

Ja lopetetaan valitettavsti tällä kertaa lyhyeen yhtä tutulla pkg.removed komennolla ajanhallinnallisten ongelmien pakottamana. Ajamme taas komennon kahdesti ja käytännössä saman mitä äskeisessä kohdassa. Tällä kertaa tavoiteltu tila on vain päinvastainen. Katsotaan onko jotain ja poistetaan se, jos on. Katsotaan uudestaan; ei poistettavaa eli onnitunut suoritus! Järjestelmän tila ei muuttunut. Tilanne on taas idempotentti.
Emme nyt käy fyysisesti orjakoneilla katsomassa onko siellä tapahtunut muutoksia. Luotetaan siihen mitä suola ja mestari meille kertovat.

### f) Kerää teknistä tietoa orjista verkon yli (grains.item)

Siirytään vielä pikaisesti keräämään tietoa minioneista edelleen jatkaen Teron artikkelin näyttämällä suunnalla ja siitä pahemmin poikkeamatta.
Ajamme kaksi komentoa joista toinen on laaja ja toinen hyvin spesifi. "sudo salt '_' grains.items" hakee kaikkien minionien kaikki ominaisuustiedot ja palauttaa ne.
"sudo salt '_' grains.item osfinger ipv4" hakee kaikilta orjilta niiden käyttöjärjestelmän ja sen version tietoja, sekä tässä tilanteessa varmaan kaksi sisäisen verkon ip osoitetta ja localhostin ip osoitteen.

```
vagrant@tmaster:~$ sudo salt '*' grains.items
t001:
    ----------
    biosreleasedate:
        12/01/2006
    biosversion:
        VirtualBox
    cpu_flags:
        - fpu
        - vme
        - de
        - pse
        - tsc
        - msr
        - pae
        - mce
        - cx8
        - apic
        - sep
        - mtrr
        - pge
        - mca
        - cmov
        - pat
        - pse36
        - clflush
        - mmx
        - fxsr
        - sse
        - sse2
        - ht
        - syscall
        - nx
        - rdtscp
        - lm
        - constant_tsc
        - rep_good
        - nopl
        - xtopology
        - nonstop_tsc
        - cpuid
        - tsc_known_freq
        - pni
        - pclmulqdq
        - ssse3
        - cx16
        - pcid
        - sse4_1
        - sse4_2
        - movbe
        - popcnt
        - aes
        - xsave
        - avx
        - rdrand
        - hypervisor
        - lahf_lm
        - abm
        - 3dnowprefetch
        - invpcid_single
        - fsgsbase
        - bmi1
        - avx2
        - bmi2
        - invpcid
        - rdseed
        - clflushopt
        - md_clear
        - flush_l1d
        - arch_capabilities
    cpu_model:
        11th Gen Intel(R) Core(TM) i7-11370H @ 3.30GHz
    cpuarch:
        x86_64
    cwd:
        /
    disks:
        - sda
    dns:
        ----------
        domain:
            lan
        ip4_nameservers:
            - 10.0.2.3
        ip6_nameservers:
        nameservers:
            - 10.0.2.3
        options:
        search:
            - lan
        sortlist:
    domain:
    fqdn:
        t001
    fqdn_ip4:
        - 127.0.1.1
        - 127.0.1.1
        - 127.0.1.1
    fqdn_ip6:
    fqdns:
    gid:
        0
    gpus:
        |_
          ----------
          model:
              SVGA II Adapter
          vendor:
              vmware
    groupname:
        root
    host:
        t001
    hwaddr_interfaces:
        ----------
        eth0:
            08:00:27:8d:c0:4d
        eth1:
            08:00:27:b4:de:20
        lo:
            00:00:00:00:00:00
    id:
        t001
    init:
        systemd
    ip4_gw:
        10.0.2.2
    ip4_interfaces:
        ----------
        eth0:
            - 10.0.2.15
        eth1:
            - 192.168.12.100
        lo:
            - 127.0.0.1
    ip6_gw:
        False
    ip6_interfaces:
        ----------
        eth0:
            - fe80::a00:27ff:fe8d:c04d
        eth1:
            - fe80::a00:27ff:feb4:de20
        lo:
            - ::1
    ip_gw:
        True
    ip_interfaces:
        ----------
        eth0:
            - 10.0.2.15
            - fe80::a00:27ff:fe8d:c04d
        eth1:
            - 192.168.12.100
            - fe80::a00:27ff:feb4:de20
        lo:
            - 127.0.0.1
            - ::1
    ipv4:
        - 10.0.2.15
        - 127.0.0.1
        - 192.168.12.100
    ipv6:
        - ::1
        - fe80::a00:27ff:fe8d:c04d
        - fe80::a00:27ff:feb4:de20
    kernel:
        Linux
    kernelparams:
        |_
          - BOOT_IMAGE
          - /boot/vmlinuz-5.10.0-26-amd64
        |_
          - root
          - None
        |_
          - ro
          - None
        |_
          - consoleblank
          - 0
        |_
          - elevator
          - noop
        |_
          - scsi_mod.use_blk_mq
          - Y
        |_
          - net.ifnames
          - 0
        |_
          - biosdevname
          - 0
    kernelrelease:
        5.10.0-26-amd64
    kernelversion:
        #1 SMP Debian 5.10.197-1 (2023-09-29)
```

Ylempi tuloste siis jatkuu vielä todella pitkään ja tulostaa KAIKEN. Eivälttämättä mielekkäin tapa kerätä tietoa. Alempi näyttää vähän järkevämmältä. Vielä kun se voidaan kohdistaa vain yhteen tai muutamaan koneeseen isossa verkossa.

```
vagrant@tmaster:~$ sudo salt '*' grains.item osfinger ipv4
t002:
    ----------
    ipv4:
        - 10.0.2.15
        - 127.0.0.1
        - 192.168.12.102
    osfinger:
        Debian-11
t001:
    ----------
    ipv4:
        - 10.0.2.15
        - 127.0.0.1
        - 192.168.12.100
    osfinger:
        Debian-11
```

### g) Aja shell-komento orjalla verkon yli.

Laitetaan minion moikkaamaan maailmaa komennolla: vagrant@tmaster:~$ sudo salt 't001' cmd.run 'echo "Hello, World!"'
Artikkelissa oli kohta "If none of the others work, we can use cmd.run state. But we must make it idempotent ourselves." ja parin kokeilun jälkeen kätyri jo vastasi.

```
vagrant@tmaster:~$ sudo salt 't001' cmd.run 'echo "Hello, World!"'
t001:
    Hello, World!
```

### h) Hello, IaC. Tee infraa koodina kirjoittamalla /srv/salt/hello/init.sls. Aja tila jollekin orjalle. Tila voi esimerkiksi tehdä esimerkkitiedoston johonkin hakemistoon. Testaa toisella komennolla, että pyytämäsi muutos on todella tehty.

Ohjetta noudattamalla alkuun luodaan kansio ja .sls tiedosta ja kirjoitetaan tiedostoon myös ohjeen mukaan sisentämällä kahdella tabulaattorilla. Cat komento näyttää että kahdella speissillä ollaan tultu. Ajetaan state.apply komento joka ilmoittaa, että komento on onnistunut ja molemmat orjat ovat luoneet tyhjän tiedoston infra-as-code /tmp/ hakemistoon. Eli state.apply laittaa minionit suorittamaan niille annettuja tiloja.

```
sudo mkdir -p /srv/salt/hello
sudoedit /srv/salt/hello/init.sls
vagrant@tmaster:~$ cat /srv/salt/hello/init.sls
/tmp/infra-as-code:
  file.managed
vagrant@tmaster:~$ sudo salt '*' state.apply hello
t001:
----------
          ID: /tmp/infra-as-code
    Function: file.managed
      Result: True
     Comment: Empty file
     Started: 03:00:05.925805
    Duration: 9.827 ms
     Changes:
              ----------
              new:
                  file /tmp/infra-as-code created

Summary for t001
------------
Succeeded: 1 (changed=1)
Failed:    0
------------
Total states run:     1
Total run time:   9.827 ms
t002:
----------
          ID: /tmp/infra-as-code
    Function: file.managed
jatkuu...
```

Käpistellään vielä "/srv/salt/top.sls"-tiedostoa, jolla ilmeisesti voidaan määritellä mitä tiloja kunkin minionin tulee ajaa.
Käsitellään siis top.sls tiedostoon haluttu pyydetty yaml configuraatio ja tarkistetaan, että sisennykset menevät oikein. Printataan se taas ulos catilla nähtäväksi tähän samaan syssyyn. Suoritus onnistunut, eli enään ei tarvitse nimetä erikseen moduulia.

```
vagrant@tmaster:~$ sudoedit /srv/salt/top.sls
vagrant@tmaster:~$ sudo salt '*' state.apply
t001:

---

          ID: /tmp/infra-as-code
    Function: file.managed
      Result: True
     Comment: File /tmp/infra-as-code exists with proper permissions. No changes made.
     Started: 04:12:02.201075
    Duration: 7.983 ms
     Changes:

## Summary for t001

Succeeded: 1
Failed: 0

---

Total states run: 1
Total run time: 7.983 ms
t002:

---
```

Tuhotaan vielä tämän session koneet ensin lopettamalla SSH-yhteys ja sen jälkeen komennolla "vagrant destroy"

```
vagrant@tmaster:~$ exit
logout
Connection to 127.0.0.1 closed.

C:\Users\verne\HH\palvhal\h2\master_minion>vagrant destroy
    tmaster: Are you sure you want to destroy the 'tmaster' VM? [y/N] y
==> tmaster: Forcing shutdown of VM...
==> tmaster: Destroying VM and associated drives...
    t001: Are you sure you want to destroy the 't001' VM? [y/N] y
==> t001: Forcing shutdown of VM...
==> t001: Destroying VM and associated drives...
```

Kiitos!
